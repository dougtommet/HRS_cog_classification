

## Model 2

This was the second model I tried.  It kept the neuropsych items as separate indicators.  It allowed the neuropsych items, individual functional impairment indicators, subjective memory complaints, and informant scores to vary by class.

```{r}
pmm_103b <- MplusAutomation::readModels(here::here("mplus_output", "pmm_103", "pmm_hcap_103b.out"))
PMM_100 <- readRDS(here::here("R_objects", "PMM_100.RDS"))
inhcap <- PMM_100 %>%
  filter(inHCAP==1)
```

### Parameter estimates

These are the parameter estimates to show which were constrained to be equal or allowed to vary by class.

```{r}
#| tbl-cap: "Unstandardized means/intercepts/thresholds by class"
pmm_103b[["parameters"]][["unstandardized"]] %>%
  filter(!grepl("ON", paramHeader)) %>%
  filter(grepl("Thresholds", paramHeader)|
           grepl("Means", paramHeader)|
           grepl("Intercepts", paramHeader)) %>%
  filter(!grepl("Categorical.Latent.Variables", LatentClass)) %>%
  select(param, est, LatentClass) %>%
  pivot_wider(names_from = LatentClass, values_from = est, names_prefix = "class_") %>%
  gt::gt()
```

```{r}
#| tbl-cap: "Untandardized covariances by class"
pmm_103b[["parameters"]][["unstandardized"]] %>%
  filter(!grepl("ON", paramHeader)) %>%
  filter(grepl("WITH", paramHeader)) %>%
  mutate(param = str_c(paramHeader, " ", param),
         param = str_replace(param, "\\.", " ")) %>%
  select(param, est, LatentClass) %>%
  pivot_wider(names_from = LatentClass, values_from = est, names_prefix = "class_") %>%
  gt::gt()
```



### Class probabilities

There were no participants that had a greater than 50% probability of being in class 2.  So I created a new classification rule where if a participant had a greater than 10% probability of being in class 2 then they were classified as being in class 2, otherwise they were their most likely class.

```{r}

cprob_103b <- pmm_103b[["savedata"]] %>%
  as_tibble() %>%
  janitor::clean_names()

cprob_103b <- cprob_103b %>%
  rowwise() %>%
  mutate(c_dt = case_when(cprob2 > 0.1 ~ 2,
                          cprob1 > cprob3 ~ 1,
                          cprob1 < cprob3 ~ 3
                          )
         ) %>%
  ungroup()

labelled::var_label(cprob_103b$c_dt) <- "Model classification (modified)"

foo <- inhcap %>%
  select(vs1hcapdxeap) %>%
  bind_cols(cprob_103b)
```


```{r}
#| fig-cap: "Distribution of the class probibilities by the most likely class"
cprob_103b %>%
  select(id, cprob1, cprob2, cprob3) %>%
  pivot_longer(names_to = "c", values_to = "prob", cols = c(cprob1, cprob2, cprob3)) %>%
  ggplot(aes(x = prob)) +
  geom_histogram() +
  facet_grid(c ~ .) +
  hrbrthemes::theme_ipsum()
```

```{r}
#| tbl-cap: "Model classification vs algorithmic diagnosis"
gtsummary::tbl_cross(foo, vs1hcapdxeap, c_dt)
```

Kappa

```{r}
psych::cohen.kappa(table(foo$vs1hcapdxeap, foo$c_dt))
```



```{r}
#| fig-cap: "Distribution of class probabilities by Algorithmic Dx"
inhcap %>%
  select(vs1hcapdxeap) %>%
  bind_cols(cprob_103b) %>%
  select(id, cprob1, cprob2, cprob3, c, vs1hcapdxeap) %>%
  pivot_longer(names_to = "cprob", values_to = "prob", 
               cols = c(cprob1, cprob2, cprob3)) %>%
  mutate(vs1hcapdxeap_f = factor(vs1hcapdxeap, levels = 1:3, labels = c("Normal", "MCI", "Demented")),
         cprob = str_replace(cprob, "cprob", "class_")) %>%
  ggplot(aes(x = prob, vs1hcapdxeap_f)) +
  geom_boxplot() +
  facet_grid(cprob ~ .) +
  scale_y_discrete("Algorithmic Dx") +
  scale_x_continuous("Class probibility") +
  hrbrthemes::theme_ipsum()
  


```


