---
title: "HRS algorithm"
author: "Doug Tommet"
date: '`r Sys.Date()`'
format: 
  html:
    toc: true
    self-contained: true
execute:
  echo: true
  warning: false
  message: false
---

This report is just in case you can't run the file 030-apply_algorithm.r.  I put the code from that file into one code chunk.


```{r}

source(here::here("R", "001-libraries.R"))
source(here::here("R", "002-folder_paths.R"))

hrs16_cog <- readRDS(fs::path(r_objects_folder, "025_hrs16_cog.rds"))
hrs16_cog_norm <- readRDS( fs::path(r_objects_folder, "025_hrs16_cog_norm.rds"))
hrs16_iadl <- readRDS(fs::path(r_objects_folder, "012_hrs16_iadl.rds"))
hrs16_func <- readRDS(fs::path(r_objects_folder, "010_hrs16_func.rds"))

hrs16_func <- hrs16_func  %>%
  mutate(self_concerns = case_when(PD102==3 ~ 1,
                                   PD102 %in% c(1, 2) ~ 0)) %>%
  select(HHID, PN, self_concerns)

# Not able to get the same centiles of 36.0 and 43.3 as in the google presentations
quantile(hrs16_cog_norm$TF, probs = c(.15, .35), na.rm=TRUE)

hcap <- hrs16_cog_norm %>%
  left_join(hrs16_iadl, by = c("HHID" = "HHID", "PN" = "PN")) %>%
  left_join(hrs16_func, by = c("HHID" = "HHID", "PN" = "PN"))


hcap <- hcap %>%
  mutate(cog_imp = case_when(TF <36.0 ~ 2,
                             TF < 43.3 ~ 1,
                             !is.na(TF) ~ 0))
gtsummary::tbl_summary(hcap, include = c(cog_imp),
                       type = c(cog_imp) ~ "categorical")

# HCAP sample with severe cog impairment
hcap_2 <- hcap %>%
  filter(cog_imp==2)

gtsummary::tbl_summary(hcap_2, include = c(iadl_imp),
                       type = c(iadl_imp) ~ "categorical")
# HCAP sample functional impairment: 375/591 = 63%
# The IADL cutpoints that get the closet: 1+ 24/124 = 19%

# HCAP sample with mild cog impairment
hcap_1 <- hcap %>%
  filter(cog_imp==1)

gtsummary::tbl_summary(hcap_1, include = c(iadl_imp),
                       type = c(iadl_imp) ~ "categorical")
# HCAP sample functional impairment: 556/726 = 75%
# The IADL cutpoints that get the closet: 1+ 60/317 = 19%


#########################
# apply algorithm in HRS

hrs <- hrs16_cog %>%
  left_join(hrs16_iadl, by = c("HHID" = "HHID", "PN" = "PN")) %>%
  left_join(hrs16_func, by = c("HHID" = "HHID", "PN" = "PN"))


hrs <- hrs %>%
  mutate(cog_threshold = case_when(TF <36.0 ~ 2,
                             TF < 43.3 ~ 1,
                             !is.na(TF) ~ 0),
         iadl_threshold = case_when(cog_threshold==2 & iadl_imp>0 ~ 1,
                                    cog_threshold==2 & iadl_imp==0 ~ 0,
                                    cog_threshold==1 & iadl_imp>0 ~ 1,
                                    cog_threshold==1 & iadl_imp==0 ~ 0))

hrs <- hrs %>%
  mutate(dx = case_when(cog_threshold==2 & iadl_threshold==1 ~ 2,
                        cog_threshold==2 & iadl_threshold==0 & self_concerns==1 ~ 2,
                        cog_threshold==2 & iadl_threshold==0 & self_concerns==0 ~ 1,
                        cog_threshold==1 & iadl_threshold==1 ~ 1,
                        cog_threshold==1 & iadl_threshold==0  & self_concerns==1~ 1,
                        cog_threshold==1 & iadl_threshold==0  & self_concerns==0~ 0,
                        cog_threshold==0 ~ 0
                        ))
QSPtools::checkvar(hrs, dx, cog_threshold, iadl_threshold, self_concerns)

hrs <- hrs %>%
  labelled::set_variable_labels(dx = "Algorithm Dx") %>%
  labelled::set_value_labels(dx = c("Normal" = 0, "MCI" = 1, "Dementia" = 2))

hrs %>%
  select(dx) %>%
  labelled::to_factor() %>%
  gtsummary::tbl_summary()

```
